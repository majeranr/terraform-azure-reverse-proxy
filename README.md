# Terraform - Azure - Reverse proxy, two web servers, custom VNet

### Features

- Two Apache2 web servers built on Azure Linux VMs (Ubuntu 18.04-lts-gen2)
- Nginx reverse proxy server in front w/ built-in simple, round-robin load balancer, built on Azure Linux VM (Ubuntu 18.04-lts-gen2)
- Bash bootstrap scripts included, no manual action on VMs required
- VMs with disabled password authentication, SSH key only
- SSH key pair generated by Terraform
- Azure storage accounts for boot diagnostics will be created separately for each VM
- Custom VNet w/ one public and one private subnet, web servers able to access Internet via NAT gateway
- Custom Azure Network Security Groups
- By default 256 available IP addresses (minus those used by Azure itself) within VNet, can be simply increased if needed
- Static IP addresses for all resources (2x Azure Public IP address for reverse proxy & NAT gateway, 2x static private IP addresses for web servers)
- Small size VMs to fit into Azure's vCPUs region quota limit for free tier accounts
- Ready-to-test after providing Azure's user & subscription details

### Introductory remarks

This project assumes that you have set your Azure's user & subscription details as Terraform environment variables (preferred, for `bash` refer to: https://docs.microsoft.com/en-us/azure/developer/terraform/get-started-cloud-shell-bash?tabs=bash) within the shell you are working with or you'll provide them at the beginning of deployment process (insecure)!

Variables to set up for project to be working properly:

- ARM_SUBSCRIPTION_ID = "<Azure chosen subscription's ID>"
- ARM_TENANT_ID = "<Azure chosen subscription tenant's ID>"
- ARM_CLIENT_ID = "<Azure chosen user's ID>"
- ARM_CLIENT_SECRET = "<Azure chosen user's password>"

Remember that prefix TF_VAR_ needs to be set up for each variable if you want Terraform to use it.

I recommend setting up a separate user with RBAC for Terraform use only (increased security).

*WARNING! Everything has been prepared to fit into Azure's free tier account, but I do not take responsibility for any costs charged by Microsoft.*

### Deployment

1. Create `.tfvars` file if you want to adjust variables, however all of them, excluding Azure's user & subscription details, have default values set up so it is not required

2. Run the `terraform init` in the `root module`

3. Run `terraform plan`

4. Review the displayed plan, if everything was done properly Terraform should inform you that 24 resources will be created

5. Run `terraform apply` and confirm with `yes`

6. Wait for resources to be built

7. `id_rsa` file, so the SSH private key file will be placed in `root module`, public key is placed automatically on VMs

### Outputs

- Reverse proxy server public IP address (`rp_public_ip_address`)
- NAT gateway public IP address (`nat_gw_public_ip_address`)
- SSH private key (`tls_private_key` - will be displayed as sensitive value)

### Test

1. Copy & paste reverse proxy server's public IP address into web browser

2. If text: "Welcome to WebServer01!" is displayed and, after refreshing the page, it changes to "Welcome to WebServer02!", everything is working fine.
